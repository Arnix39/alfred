{
    "version": "2.0.0",
    "tasks": [
        {
            "label": "ROS2: Build workspace",
            "detail": "Build workspace for host machine.",
            "type": "shell",
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "command": "colcon",
            "args": [
                "build",
                "--build-base",
                "build/host",
                "--install-base",
                "install/host",
                "--symlink-install",
                "--cmake-args",
                "-DCMAKE_EXPORT_COMPILE_COMMANDS=ON",
                "-DSYNTHETIC_BUILD:BOOL=ON"
            ],
            "group": {
                "kind": "build",
                "isDefault": true
            },
            "problemMatcher": "$gcc"
        },
        {
            "label": "ROS2: Unit tests",
            "detail": "Run unit tests.",
            "type": "shell",
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "command": "colcon",
            "args": [
                "test",
                "--build-base",
                "build/host",
                "--install-base",
                "install/host",
            ],
            "group": {
                "kind": "test",
            }
        },
        {
            "label": "ROS2: Tests results",
            "detail": "Show unit tests results.",
            "type": "shell",
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "command": "colcon",
            "args": [
                "test-result",
                "--test-result-base",
                "build/host",
            ],
            "group": {
                "kind": "test",
            }
        },
        {
            "label": "ROS2: Run tests",
            "detail": "Run all unit tests and show results.",
            "type": "shell",
            "dependsOrder": "sequence",
            "dependsOn": ["ROS2: Build workspace", "ROS2: Unit tests", "ROS2: Tests results"],
            "group": {
                "kind": "test",
                "isDefault": true
            }
        },
        {
            "label": "Workspace: Clean host files",
            "detail": "Clean workspace for host build files.",
            "type": "shell",
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "command": "colcon",
            "args": [
                "build",
                "--build-base",
                "build/host",
                "--install-base",
                "install/host",
                "--cmake-target",
                "clean"
            ],
        },
        {
            "label": "Workspace: Generate sysroot for target",
            "detail": "Generate sysroot for cross compilation for Raspberry Pi 3B+.",
            "type": "shell",
            "options": {
                "cwd": "${workspaceFolder}/cross_compile"
            },
            "command": "${workspaceFolder}/cross_compile/generate_sysroot.sh",
        },
        {
            "label": "ROS2: Build workspace for target",
            "detail": "Build workspace for Raspberry Pi 3B+.",
            "type": "shell",
            "options": {
                "cwd": "${workspaceFolder}",
                "env": {
                    "TARGET_ARCH": "aarch64",
                    "CROSS_COMPILE": "/usr/bin/aarch64-linux-gnu-",
                    "SYSROOT": "${workspaceFolder}/cross_compile/sysroot",
                    "ROS2_INSTALL_PATH": "${workspaceFolder}/install/target",
                    "PYTHON_SOABI": "cpython-310-aarch64-linux-gnu",
                    "CC": "/usr/bin/aarch64-linux-gnu-gcc",
                    "CXX": "/usr/bin/aarch64-linux-gnu-g++",
                    "CROSS_COMPILE_DIR": "${workspaceFolder}/cross_compile",
                }
            },
            "command": "colcon",
            "args": [
                "build",
                "--build-base",
                "build/target",
                "--install-base",
                "install/target",
                "--symlink-install",
                "--cmake-args",
                "-DCMAKE_VERBOSE_MAKEFILE:BOOL=ON",
                "-DCMAKE_TOOLCHAIN_FILE=${CROSS_COMPILE_DIR}/cmake-toolchains/generic_linux.cmake"
            ],
            "group": {
                "kind": "build"
            },
            "problemMatcher": "$gcc"
        },
        {
            "label": "Workspace: Clean target files",
            "detail": "Clean workspace for target build files.",
            "type": "shell",
            "options": {
                "cwd": "${workspaceFolder}",
                "env": {
                  "TARGET_ARCH": "aarch64",
                  "CROSS_COMPILE": "/usr/bin/aarch64-linux-gnu-",
                  "SYSROOT": "${workspaceFolder}/cross_compile/sysroot/",
                  "ROS2_INSTALL_PATH": "${workspaceFolder}/install/target",
                  "PYTHON_SOABI": "cpython-310-aarch64-linux-gnu",
                  "CC": "/usr/bin/aarch64-linux-gnu-gcc",
                  "CXX": "/usr/bin/aarch64-linux-gnu-g++",
                  "CROSS_COMPILE_DIR": "${workspaceFolder}/cross_compile",
                }
            },
            "command": "colcon",
            "args": [
                "build",
                "--build-base",
                "build/target",
                "--install-base",
                "install/target",
                "--cmake-target",
                "clean"
            ],
        },
        {
            "label": "Workspace: Purge",
            "detail": "Purge workspace by deleting all generated files.",
            "type": "shell",
            "command": "rm",
            "options": {
                "cwd": "${workspaceFolder}"
            },
            "args": [
                "-fr",
                "build",
                "install",
                "log"
            ],
        },
        {
            "label": "Install on target",
            "detail": "Install workspace on Raspberry Pi 3B+.",
            "type": "shell",
            "command": "../scripts/install_on_Alfred.sh",
            "args": [
                "${workspaceFolder}/install/target",
            ],
        },
    ]
}